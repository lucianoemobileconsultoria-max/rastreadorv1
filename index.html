<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Painel de LOCALIZADOR DE M√ÅQUINAS</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèóÔ∏è</text></svg>">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 85vh; width: 100%; }
    .leaflet-popup-content-wrapper { border-radius: 0.75rem; }
    .leaflet-popup-content { font-size: 1rem; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-violet-800 min-h-screen">
  <nav class="bg-white/90 shadow-lg mb-5 flex items-center justify-between px-6 py-3">
  
  </nav>

  <main class="mx-auto px-4 w-full">
    <section class="mb-7 flex flex-col md:flex-row gap-4 items-center justify-between">
      <h1 class="text-3xl md:text-4xl font-extrabold text-white mb-3 md:mb-0 drop-shadow-lg">
        LOCALIZADOR DE M√ÅQUINAS
      </h1>
      <button id="atualizarBtn"
        class="bg-white hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-5 rounded-lg shadow transition-all">
        Atualizar Dados
      </button>
    </section>
    <div class="bg-white/90 rounded-2xl shadow-lg p-2 mb-4 h-full flex flex-col md:flex-row gap-5">
      <div class="flex-1 min-w-0">
        <div id="map" class="rounded-2xl overflow-hidden shadow-lg"></div>
      </div>
	      <div class="md:w-96 flex flex-col gap-5 justify-between">
	        
          <button id="toggleIconesMenuBtn" class="w-full bg-white hover:bg-indigo-50 text-indigo-700 font-bold py-3 px-4 rounded-lg shadow transition-all flex justify-between items-center">
            <span>Gerenciar √çcones</span>
            <span id="menuIconeChevron" class="transform transition-transform">‚ñº</span>
          </button>

	        <div id="menuIconesContainer" class="hidden -mt-4"> <div id="crudIcones" class="bg-white rounded-lg shadow-inner p-4"> 
	            <div class="bg-white rounded-xl shadow px-4 py-3 mb-4">
	              <h3 id="formIconeTitulo" class="text-lg font-bold text-indigo-700 mb-2">Cadastrar Novo √çcone</h3>
	              <form id="cadastroIconeForm" class="flex flex-col gap-3">
	                <input type="hidden" id="editIconeId" name="editIconeId" />
	                <div>
	                  <label for="nomeIcone" class="block text-xs font-semibold text-gray-700 mb-1">Nome:</label>
	                  <input type="text" id="nomeIcone" name="nomeIcone" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
	                </div>
	                <div>
	                  <label for="urlIcone" class="block text-xs font-semibold text-gray-700 mb-1">URL/Nome do √çcone (Geoapify/FontAwesome):</label>
	                  <input type="text" id="urlIcone" name="urlIcone" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: mobile-alt, home, car" />
	                </div>
	                <button type="submit" class="bg-indigo-700 text-white font-bold py-1 px-4 rounded shadow hover:bg-indigo-800 transition" id="submitIconeBtn">Cadastrar √çcone</button>
	                <button type="button" class="bg-gray-500 text-white font-bold py-1 px-4 rounded shadow hover:bg-gray-600 transition hidden" id="cancelEditIconeBtn">Cancelar Edi√ß√£o</button>
	                <p id="mensagemCadastroIcone" class="mt-1 text-xs"></p>
	              </form>
	            </div>
	            <ul id="listaIcones" class="flex flex-wrap gap-2 mb-4">
	              </ul>
	          </div>
          </div>

          <button id="toggleCadastroMenuBtn" class="w-full bg-white hover:bg-indigo-50 text-indigo-700 font-bold py-3 px-4 rounded-lg shadow transition-all flex justify-between items-center -mt-4"> <span id="tituloMenuCadastro">Cadastrar Novo Celular</span>
            <span id="menuCadastroChevron" class="transform transition-transform">‚ñº</span>
          </button>

	        <div id="menuCadastroContainer" class="hidden -mt-4"> <div class="bg-white rounded-xl shadow-inner px-4 py-3">
              <form id="cadastroForm" class="flex flex-col gap-3">
                <input type="hidden" id="editId" name="editId" />
                <div>
                  <label for="nome" class="block text-xs font-semibold text-gray-700 mb-1">Nome:</label>
                  <input type="text" id="nome" name="nome" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                  <label for="numero" class="block text-xs font-semibold text-gray-700 mb-1">N√∫mero do celular:</label>
                  <input type="text" id="numero" name="numero" required class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                </div>
                <div>
                  <label for="icone_maquina" class="block text-xs font-semibold text-gray-700 mb-1">√çcone:</label>
                  <select id="icone_maquina" name="icone_maquina" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </select>
                </div>
                <button type="submit" class="bg-indigo-700 text-white font-bold py-1 px-4 rounded shadow hover:bg-indigo-800 transition" id="submitBtn">Cadastrar</button>
                <button type="button" class="bg-gray-500 text-white font-bold py-1 px-4 rounded shadow hover:bg-gray-600 transition hidden" id="cancelEditBtn">Cancelar</button>
                <p id="mensagemCadastro" class="mt-1 text-xs"></p>
              </form>
            </div>
          </div>
          <div>
	          <h2 class="text-xl text-indigo-700 font-bold mb-2">Celulares cadastrados</h2>
	          <ul id="listaCelulares" class="flex-1 space-y-2"></ul>
	        </div>
            
            <div>
              <h2 class="text-xl text-indigo-700 font-bold mb-2">Hist√≥rico de Trajeto</h2>
              
              <div class="flex gap-2 items-center mb-2">
                <label for="dataTrajeto" class="text-sm font-medium text-gray-700">Filtrar por Dia:</label>
                <input type="date" id="dataTrajeto" class="p-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
              </div>

              <div id="historicoContainer" class="bg-indigo-50 rounded-lg shadow-inner border-l-4 border-indigo-500 p-3 max-h-60 overflow-y-auto">
                  <p id="historicoStatus" class="text-gray-500">Selecione "Trajeto" de um celular para ver o hist√≥rico.</p>
                  <table id="historicoTabela" class="min-w-full text-sm hidden">
                      <thead class="border-b-2 border-indigo-200">
                          <tr>
                              <th class="text-left font-semibold p-1">Data/Hora</th>
                              <th class="text-left font-semibold p-1">Coords</th>
                          </tr>
                      </thead>
                      <tbody id="historicoLista"></tbody>
                  </table>
              </div>
            </div>
            </div>
    </div>
    <footer class="mt-8 text-white/70 text-center">Painel - SupabaseDB ¬© 2025</footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Troque pelos seus dados!
    const SUPABASE_URL = 'https://rptxfjlxymfmxucctuhc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdHhmamx4eW1mbXh1Y2N0dWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTcxNjMsImV4cCI6MjA3NzEzMzE2M30.kQSF0jp_-0Qi2AmHQNKz6eTo7zeEi3b7Lk9UjT216dU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const apiKey = "9452fa947c234c90b794bf2d1b8c5eb4"; // Geoapify para Leaflet
    const map = L.map('map').setView([-14.2, -51.9], 4);
    
    let polylineLayer = null; // Guarda a linha do trajeto no mapa

    const osmLibertyLayer = L.tileLayer(`https://maps.geoapify.com/v1/tile/osm-liberty/{z}/{x}/{y}.png?apiKey=${apiKey}`, {
      attribution: '¬© OpenStreetMap, Geoapify',
      maxZoom: 19,
    });
    
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri',
      maxZoom: 19
    });

    osmLibertyLayer.addTo(map);

    const baseMaps = {
      "Mapa (Padr√£o)": osmLibertyLayer,
      "Sat√©lite": satelliteLayer 
    };

    L.control.layers(baseMaps).addTo(map);

    function copiarCoords(lat, lng) {
      const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      navigator.clipboard.writeText(googleMapsLink).then(() => {
        alert('Link do Google Maps copiado!');
      }, () => {
        alert('Falha ao copiar o link.');
      });
    }

    function shareWhatsApp(nome, lat, lng) {
      const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      const texto = `Localiza√ß√£o para *${nome}*:\n${googleMapsLink}`;
      
      const whatsappLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
      window.open(whatsappLink, '_blank');
    }

    async function deletarPonto(id) {
      if (!confirm('Tem certeza que deseja excluir este Ponto de Interesse?')) return;

      const { error } = await supabase
        .from('usuarios_localizacao')
        .delete()
        .eq('id', id);

      if (error) {
        alert("Erro ao excluir o ponto: " + error.message);
      } else {
        alert("Ponto exclu√≠do com sucesso!");
        map.closePopup();
        buscarCelulares();
      }
    }

    // --- FUN√á√ÉO PARA SOLICITAR LOCALIZA√á√ÉO (CORRIGIDA E SIMPLIFICADA) ---
    async function solicitarLocalizacao(usuarioId, targetButton) {
        targetButton.disabled = true;
        targetButton.textContent = 'Enviando...';

        try {
            // A biblioteca da Supabase lida com a serializa√ß√£o. Passamos o objeto diretamente.
            const { data, error } = await supabase.functions.invoke('request-location', {
                body: { usuarioId: usuarioId },
            });

            if (error) throw error; 

            if (data && data.success) {
                alert(`‚úÖ Solicita√ß√£o de localiza√ß√£o enviada com sucesso!`);
                targetButton.textContent = 'Enviado!';
            } else {
                const errorMessage = data ? data.error : 'Resposta inv√°lida da fun√ß√£o.';
                alert(`‚ö†Ô∏è Falha ao enviar solicita√ß√£o: ${errorMessage || 'Erro desconhecido.'}`);
                targetButton.textContent = 'Falhou';
            }

        } catch (error) {
            console.error('Erro detalhado ao invocar a Edge Function:', error);
            let detailedMessage = error.message;
            // Tenta extrair uma mensagem de erro mais detalhada do contexto, se dispon√≠vel
            if (error.context && typeof error.context.json === 'function') {
                try {
                    const errorJson = await error.context.json();
                    detailedMessage = errorJson.error || detailedMessage;
                } catch (e) { /* ignora erro de parsing */ }
            } else if (error.context) {
                detailedMessage += ` | Contexto: ${JSON.stringify(error.context)}`;
            }
            alert(`‚ùå Erro cr√≠tico ao tentar enviar a solicita√ß√£o: ${detailedMessage}`);
            targetButton.textContent = 'Erro';
        } finally {
            setTimeout(() => {
                targetButton.disabled = false;
                targetButton.textContent = 'Solicitar Localiza√ß√£o';
            }, 5000);
        }
    }

    async function buscarCelulares() {
      const { data: lista, error } = await supabase
        .from('usuarios_localizacao')
        .select('*'); 
      if (error) {
        document.getElementById('listaCelulares').innerHTML = '<li class="text-red-500">Erro ao buscar dados</li>';
        return;
      }

      if (window.markers) window.markers.forEach(m => map.removeLayer(m));
      window.markers = [];
      document.getElementById('listaCelulares').innerHTML = '';

      (lista || []).filter(c => c.latitude && c.longitude).forEach(({ id, nome, numero, latitude, longitude, created_at, icone_maquina }) => {
        
        const isPontoMarcado = !numero;
        const iconeCor = isPontoMarcado ? '%23c91f1f' : '%23631fc9';
        const iconeLabel = isPontoMarcado ? 'location-pin' : (icone_maquina || 'mobile-alt');

        const markerIcon = L.icon({
          iconUrl: `https://api.geoapify.com/v1/icon/?type=material&color=${iconeCor}&size=large&icon=${iconeLabel}&apiKey=${apiKey}`,
          iconSize: [38, 58],
          iconAnchor: [19, 56],
          popupAnchor: [0, -50],
        });

        const texto = `
          <div class="text-indigo-700 font-bold text-lg mb-1">${nome}</div>
          ${numero ? 
            `<div class="font-medium text-gray-600">Celular: <span>${numero}</span></div>` : 
            '<div class="font-medium text-gray-600">Ponto de Interesse</div>'
          }
          <div class="text-xs text-gray-600 mt-1">Registrado: ${created_at ? new Date(created_at).toLocaleString('pt-BR') : '---'}</div>
          <div class="text-xs text-gray-600">Lat: ${latitude?.toFixed(6)}, Lng: ${longitude?.toFixed(6)}</div>
          
          <div class="mt-3 flex flex-wrap gap-2">
            <button onclick="copiarCoords(${latitude}, ${longitude})" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded transition-all">Copiar</button>
            <button onclick="shareWhatsApp('${nome.replace(/'/g, "\\'")}', ${latitude}, ${longitude})" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded transition-all">WhatsApp</button>
            ${isPontoMarcado ? 
              `<button onclick="deletarPonto(${id})" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded transition-all">Excluir</button>` : 
              ''
            }
          </div>
        `;

        const marker = L.marker([latitude, longitude], { icon: markerIcon }).addTo(map).bindPopup(texto);
        window.markers.push(marker);
        
        if (numero) {
            const item = document.createElement('li');
            item.className = 'px-3 py-2 bg-indigo-50 rounded-lg shadow border-l-4 border-indigo-500 text-sm font-medium flex flex-col gap-2';
            
            item.innerHTML = `
              <div class="flex items-center justify-between gap-2">
                <div class="flex-1 min-w-0">
                  <span class="font-bold">${nome}</span>
                  <a href="tel:${numero}" class="block text-indigo-700 underline text-xs" title="Ligar">${numero}</a>
                  <span class="text-xs text-gray-500 font-normal">${created_at ? new Date(created_at).toLocaleString('pt-BR') : ''}</span>
                </div>
                <div class="flex flex-col gap-1 items-end">
                  <button class="editarBtn bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-2 rounded shadow" data-id="${id}">Editar</button>
                  <button class="deletarBtn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded shadow" data-id="${id}">Excluir</button>
                </div>
              </div>
              <div class="flex gap-2 mt-1">
                <button class="solicitarLocalizacaoBtn bg-teal-500 hover:bg-teal-600 text-white font-bold text-xs py-1 px-2 rounded shadow w-full text-center" data-id="${id}">Solicitar Localiza√ß√£o</button>
                <button class="verHistoricoBtn bg-blue-500 hover:bg-blue-600 text-white font-bold text-xs py-1 px-2 rounded shadow w-full text-center" data-id="${id}" data-nome="${nome.replace(/'/g, "\\'")}">Trajeto</button>
              </div>
            `;
            
            document.getElementById('listaCelulares').appendChild(item);
        }
      });

      if (window.markers && window.markers.length > 0) {
        const marker = window.markers[window.markers.length - 1];
        map.setView(marker.getLatLng(), 14);
      }
      setupEventListeners();
    }

    function abrirMenuCadastro(isEdicao = false) {
      const container = document.getElementById('menuCadastroContainer');
      const chevron = document.getElementById('menuCadastroChevron');
      const titulo = document.getElementById('tituloMenuCadastro');
      
      container.classList.remove('hidden');
      chevron.textContent = '‚ñ≤';
      chevron.classList.add('rotate-180');
      
      if(isEdicao) {
        titulo.textContent = 'Editar Celular';
      } else {
        titulo.textContent = 'Cadastrar Novo Celular';
      }
    }

    function fecharMenuCadastro() {
      const container = document.getElementById('menuCadastroContainer');
      const chevron = document.getElementById('menuCadastroChevron');
      const titulo = document.getElementById('tituloMenuCadastro');
      
      container.classList.add('hidden');
      chevron.textContent = '‚ñº';
      chevron.classList.remove('rotate-180');
      titulo.textContent = 'Cadastrar Novo Celular';
    }

    async function buscarHistorico(usuarioId, nomeUsuario, dataSelecionada) {
        const historicoStatus = document.getElementById('historicoStatus');
        const historicoTabela = document.getElementById('historicoTabela');
        const historicoLista = document.getElementById('historicoLista');
        
        if (!dataSelecionada) {
            historicoStatus.textContent = "Por favor, selecione uma data.";
            return;
        }

        historicoStatus.textContent = `Calculando trajeto de ${nomeUsuario} para ${dataSelecionada}...`;
        historicoStatus.classList.remove('hidden');
        historicoTabela.classList.add('hidden');
        historicoLista.innerHTML = '';

        if (polylineLayer) {
            map.removeLayer(polylineLayer);
            polylineLayer = null;
        }

        const inicioDoDia = new Date(dataSelecionada);
        inicioDoDia.setHours(0, 0, 0, 0);
        const fimDoDia = new Date(dataSelecionada);
        fimDoDia.setHours(23, 59, 59, 999);

        const { data, error } = await supabase
            .from('historico_localizacao')
            .select('latitude, longitude, created_at')
            .eq('usuario_id', usuarioId)
            .gte('created_at', inicioDoDia.toISOString())
            .lte('created_at', fimDoDia.toISOString())
            .order('created_at', { ascending: true });

        if (error) {
            historicoStatus.textContent = `Erro ao buscar hist√≥rico: ${error.message}`;
            return;
        }

        if (data.length < 2) {
            historicoStatus.textContent = `N√£o h√° pontos suficientes (m√≠n. 2) para ${nomeUsuario} neste dia.`;
            return;
        }
        
        data.slice().reverse().forEach(ponto => {
            const item = document.createElement('tr');
            item.className = 'border-b border-indigo-100 hover:bg-indigo-200';
            item.innerHTML = `
                <td class="p-1">${new Date(ponto.created_at).toLocaleString('pt-BR')}</td>
                <td class="p-1 text-xs">${ponto.latitude.toFixed(4)}, ${ponto.longitude.toFixed(4)}</td>
            `;
            historicoLista.appendChild(item);
        });
        historicoTabela.classList.remove('hidden');

        const primeiroHorario = new Date(data[0].created_at).toLocaleTimeString('pt-BR');
        const ultimoHorario = new Date(data[data.length - 1].created_at).toLocaleTimeString('pt-BR');

        const waypoints = data.map(p => `${p.latitude},${p.longitude}`).join('|');
        const routeUrl = `https://api.geoapify.com/v1/routing?waypoints=${waypoints}&mode=drive&apiKey=${apiKey}`;

        try {
            const response = await fetch(routeUrl);
            const routeData = await response.json();

            if (routeData.features && routeData.features.length > 0) {
                const distanciaEmMetros = routeData.features[0].properties.distance;
                const distanciaEmKm = (distanciaEmMetros / 1000).toFixed(2);
                const routeLine = routeData.features[0].geometry.coordinates[0].map(p => [p[1], p[0]]);

                polylineLayer = L.polyline(routeLine, { color: '#631fc9', weight: 5, opacity: 0.8 }).addTo(map);
                map.fitBounds(polylineLayer.getBounds());

                historicoStatus.textContent = `Trajeto: ${primeiroHorario} √†s ${ultimoHorario} (${distanciaEmKm} km)`;
            } else {
                throw new Error("API da Geoapify n√£o retornou uma rota.");
            }
        } catch (err) {
            console.error("Erro ao calcular rota:", err);
            historicoStatus.textContent = `Trajeto: ${primeiroHorario} √†s ${ultimoHorario} (Erro ao calcular KM)`;
            
            const latlngs = data.map(p => [p.latitude, p.longitude]);
            polylineLayer = L.polyline(latlngs, { color: '#c91f1f', weight: 3, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
            map.fitBounds(polylineLayer.getBounds());
        }
    }

    function setupEventListeners() {
      const verHistoricoBtns = document.querySelectorAll('.verHistoricoBtn');
      const solicitarLocalizacaoBtns = document.querySelectorAll('.solicitarLocalizacaoBtn');
      const editarBtns = document.querySelectorAll('.editarBtn');
      const deletarBtns = document.querySelectorAll('.deletarBtn');
      const form = document.getElementById('cadastroForm');
      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const mensagemCadastro = document.getElementById('mensagemCadastro');
      const editId = document.getElementById('editId');
	  const nomeInput = document.getElementById('nome');
	  const numeroInput = document.getElementById('numero');
	  const iconeMaquinaInput = document.getElementById('icone_maquina');
	
      verHistoricoBtns.forEach(btn => {
        btn.onclick = () => {
            const id = btn.getAttribute('data-id');
            const nome = btn.getAttribute('data-nome');
            const dataSelecionada = document.getElementById('dataTrajeto').value;
            
            if (!dataSelecionada) {
                alert("Por favor, selecione uma data para ver o trajeto.");
                return;
            }
            buscarHistorico(id, nome, dataSelecionada);
        };
      });

      solicitarLocalizacaoBtns.forEach(btn => {
          btn.onclick = (e) => {
              const id = e.currentTarget.getAttribute('data-id');
              solicitarLocalizacao(id, e.currentTarget);
          };
      });

	  editarBtns.forEach(btn => {
	    btn.onclick = async () => {
	      const id = btn.getAttribute('data-id');
	      mensagemCadastro.textContent = "Carregando dados...";
          abrirMenuCadastro(true); 

	      const { data, error } = await supabase
	        .from('usuarios_localizacao')
	        .select('*')
	        .eq('id', id)
	        .single();
	      if (error) {
	        mensagemCadastro.textContent = "Erro ao carregar dados: " + error.message;
	        return;
	      }
	      editId.value = data.id;
	      nomeInput.value = data.nome;
		  numeroInput.value = data.numero;
	      iconeMaquinaInput.value = data.icone_maquina || "";
		  submitBtn.textContent = "Salvar";
	      cancelEditBtn.classList.remove('hidden');
	      mensagemCadastro.textContent = "";
	    };
	  });

	  cancelEditBtn.onclick = () => {
		editId.value = "";
		nomeInput.value = "";
		numeroInput.value = "";
		iconeMaquinaInput.value = "";
		submitBtn.textContent = "Cadastrar";
        cancelEditBtn.classList.add('hidden');
        mensagemCadastro.textContent = "";
        fecharMenuCadastro();
      };

      deletarBtns.forEach(btn => {
        btn.onclick = async () => {
          if (!confirm('Tem certeza que deseja excluir este registro?')) return;
          const id = btn.getAttribute('data-id');
          const { error } = await supabase
            .from('usuarios_localizacao')
            .delete()
            .eq('id', id);
          if (error) {
            alert("Erro ao excluir: " + error.message);
            return;
          }
          buscarCelulares();
        };
      });

      form.onsubmit = async (e) => {
        e.preventDefault();
        mensagemCadastro.textContent = "Enviando dados...";
        const id = editId.value;
		const payload = {
		  nome: nomeInput.value,
		  numero: numeroInput.value,
		  icone_maquina: iconeMaquinaInput.value || null
		};
        if (id) {
          const { error } = await supabase
            .from('usuarios_localizacao')
            .update(payload)
            .eq('id', id);
          if (error) {
            mensagemCadastro.textContent = "Erro ao atualizar: " + error.message;
            return;
          }
          mensagemCadastro.textContent = "Dados atualizados com sucesso!";
        } else {
          const { error } = await supabase.from('usuarios_localizacao').insert([payload]);
          if (error) {
            mensagemCadastro.textContent = "Erro ao cadastrar: " + error.message;
            return;
          }
          mensagemCadastro.textContent = "Celular cadastrado com sucesso!";
        }
        form.reset();
        cancelEditBtn.classList.add('hidden');
        submitBtn.textContent = "Cadastrar";
        fecharMenuCadastro();
	    buscarCelulares();
	  };
	}
	
	async function buscarIcones() {
	  const { data: icones, error } = await supabase
	    .from('icones_maquina')
	    .select('*');
	
	  if (error) {
	    document.getElementById('listaIcones').innerHTML = '<li class="text-red-500">Erro ao buscar √≠cones</li>';
	    return [];
	  }
	
	  const listaIconesEl = document.getElementById('listaIcones');
	  listaIconesEl.innerHTML = '';
	
	  (icones || []).forEach(icone => {
	    const item = document.createElement('li');
	    item.className = 'flex items-center gap-2 p-1 bg-gray-100 rounded shadow text-sm';
		item.innerHTML = `
		  <img src="https://api.geoapify.com/v1/icon/?type=material&color=%23631fc9&size=small&icon=${icone.label_icone}&apiKey=${apiKey}" class="w-5 h-5" alt="${icone.nome_icone}">
	      <span>${icone.nome_icone}</span>
	      <div class="flex gap-1">
	        <button class="editarIconeBtn bg-yellow-400 hover:bg-yellow-500 text-white font-bold text-xs py-0.5 px-1 rounded shadow" data-id="${icone.id}">E</button>
	        <button class="deletarIconeBtn bg-red-600 hover:bg-red-700 text-white font-bold text-xs py-0.5 px-1 rounded shadow" data-id="${icone.id}">X</button>
	      </div>
	    `;
	    listaIconesEl.appendChild(item);
	  });
	
	  setupIconeEventListeners(icones);
	  return icones;
	}
	
	function setupIconeEventListeners(icones) {
	  const editarIconeBtns = document.querySelectorAll('.editarIconeBtn');
	  const deletarIconeBtns = document.querySelectorAll('.deletarIconeBtn');
	  const form = document.getElementById('cadastroIconeForm');
	  const submitBtn = document.getElementById('submitIconeBtn');
	  const cancelEditBtn = document.getElementById('cancelEditIconeBtn');
	  const formTitulo = document.getElementById('formIconeTitulo');
	  const mensagemCadastro = document.getElementById('mensagemCadastroIcone');
	  const editId = document.getElementById('editIconeId');
	  const nomeInput = document.getElementById('nomeIcone');
	  const urlInput = document.getElementById('urlIcone');
	
	  editarIconeBtns.forEach(btn => {
	    btn.onclick = () => {
	      const id = btn.getAttribute('data-id');
	      const icone = icones.find(i => i.id == id);
	      if (!icone) return;
	
	      editId.value = icone.id;
	      nomeInput.value = icone.nome_icone;
	      urlInput.value = icone.label_icone;
	      submitBtn.textContent = "Salvar √çcone";
	      cancelEditBtn.classList.remove('hidden');
	      formTitulo.textContent = "Editar √çcone";
	      mensagemCadastro.textContent = "";
	    };
	  });
	
	  cancelEditBtn.onclick = () => {
	    editId.value = "";
	    nomeInput.value = "";
	    urlInput.value = "";
	    submitBtn.textContent = "Cadastrar √çcone";
	    cancelEditBtn.classList.add('hidden');
	    formTitulo.textContent = "Cadastrar Novo √çcone";
	    mensagemCadastro.textContent = "";
	  };
	
	  deletarIconeBtns.forEach(btn => {
	    btn.onclick = async () => {
	      if (!confirm('Tem certeza que deseja excluir este √≠cone?')) return;
	      const id = btn.getAttribute('data-id');
	      const { error } = await supabase
	        .from('icones_maquina')
	        .delete()
            .eq('id', id);
	      if (error) {
	        alert("Erro ao excluir: " + error.message);
	        return;
	      }
	      buscarIcones();
	      buscarCelulares();
	    };
	  });
	
	  form.onsubmit = async (e) => {
	    e.preventDefault();
	    mensagemCadastro.textContent = "Enviando dados...";
	    const id = editId.value;
	    const payload = {
	      nome_icone: nomeInput.value,
	      label_icone: urlInput.value
	    };
	    if (id) {
	      const { error } = await supabase
	        .from('icones_maquina')
	        .update(payload)
	        .eq('id', id);
	      if (error) {
	        mensagemCadastro.textContent = "Erro ao atualizar √≠cone: " + error.message;
	        return;
	      }
	      mensagemCadastro.textContent = "√çcone atualizado com sucesso!";
	    } else {
	      const { error } = await supabase.from('icones_maquina').insert([payload]);
	      if (error) {
	        mensagemCadastro.textContent = "Erro ao cadastrar √≠cone: " + error.message;
	        return;
          }
	      mensagemCadastro.textContent = "√çcone cadastrado com sucesso!";
	    }
	    form.reset();
	    cancelEditBtn.classList.add('hidden');
	    submitBtn.textContent = "Cadastrar √çcone";
	    document.getElementById('formIconeTitulo').textContent = "Cadastrar Novo √çcone";
	    buscarIcones();
	    carregarIconesParaSelect();
	    buscarCelulares();
	  };
	}
	
	async function carregarIconesParaSelect() {
	  const { data: icones, error } = await supabase
	    .from('icones_maquina')
	    .select('label_icone, nome_icone');
	
	  if (error) {
	    console.error("Erro ao carregar √≠cones para o select:", error.message);
	    return;
	  }
	
	  const selectEl = document.getElementById('icone_maquina');
	  selectEl.innerHTML = '<option value="">(Padr√£o: mobile-alt)</option>';
	
	  (icones || []).forEach(icone => {
	    const option = document.createElement('option');
	    option.value = icone.label_icone;
	    option.textContent = icone.nome_icone + ' (' + icone.label_icone + ')';
	    selectEl.appendChild(option);
	  });
	}

    map.on('click', async function(e) {
      const nomeMaquina = prompt("Digite o nome da m√°quina/ponto de interesse:");

      if (nomeMaquina) {
        const { lat, lng } = e.latlng;
        
        const { error } = await supabase
          .from('usuarios_localizacao')
          .insert([
            { 
              nome: nomeMaquina, 
              latitude: lat, 
              longitude: lng,
              numero: ''
            }
          ]);

        if (error) {
          alert("Erro ao salvar o ponto: " + error.message);
        } else {
          alert("Ponto salvo com sucesso!");
          buscarCelulares();
        }
      }
    });
    
    document.getElementById('toggleIconesMenuBtn').onclick = function() {
      const container = document.getElementById('menuIconesContainer');
      const chevron = document.getElementById('menuIconeChevron');
      const isHidden = container.classList.toggle('hidden');
      chevron.textContent = isHidden ? '‚ñº' : '‚ñ≤';
      chevron.classList.toggle('rotate-180', !isHidden);
    };

    document.getElementById('toggleCadastroMenuBtn').onclick = function() {
      const container = document.getElementById('menuCadastroContainer');
      const isHidden = container.classList.contains('hidden');
      if(isHidden) abrirMenuCadastro(false);
      else fecharMenuCadastro();
    };

    document.getElementById('atualizarBtn').onclick = buscarCelulares;
    document.getElementById('dataTrajeto').valueAsDate = new Date();

    // --- REALTIME SUBSCRIPTION ---
    // Ouve por mudan√ßas na tabela 'usuarios_localizacao' e recarrega os dados
    supabase
      .channel('usuarios_localizacao_changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'usuarios_localizacao' }, (payload) => {
        console.log('Mudan√ßa detectada em usuarios_localizacao, atualizando mapa...', payload);
        buscarCelulares();
      })
      .subscribe();

    buscarIcones();
    carregarIconesParaSelect();
    buscarCelulares();

  </script>
</body>
</html>
