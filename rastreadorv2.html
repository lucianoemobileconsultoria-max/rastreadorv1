<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>GEOMAQ - Rastreador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-violet-800 text-gray-900 min-h-screen flex items-center justify-center p-4">

  <div id="install-container" class="fixed top-0 left-0 right-0 bg-indigo-800 text-white p-3 text-center hidden items-center justify-center gap-4 z-50">
    <p class="font-medium">Instale o app para a melhor experi√™ncia!</p>
    <button id="install-button" class="bg-white text-indigo-700 font-bold py-1 px-4 rounded-lg shadow-md hover:bg-indigo-100 transition-all">
      Instalar App
    </button>
  </div>

  <main class="w-full max-w-md rounded-2xl shadow-2xl bg-white/95 mx-auto p-6 text-center">
    <h1 class="text-3xl font-extrabold text-indigo-700 mb-2 drop-shadow">GEOMAQ</h1>
    <p class="text-gray-600 mb-6">Rastreador On-Demand</p>

    <div class="mb-6">
      <label for="celularSelect" class="block text-gray-700 font-semibold mb-2 text-left">Selecione seu celular:</label>
      <select id="celularSelect" required class="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-base shadow text-gray-900">
        <option value="">Carregando...</option>
      </select>
      <div id="loadingMsg" class="mt-2 text-xs text-gray-600 text-left"></div>
    </div>

    <button id="subscribeButton" class="w-full bg-gradient-to-tr from-purple-600 to-indigo-700 text-white font-bold rounded-xl py-3 shadow-xl text-lg hover:scale-105 transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100" disabled>
      üîî Ativar Rastreamento On-Demand
    </button>
    
    <div id="statusMsg" class="mt-4 text-center text-sm font-medium h-10"></div>
    
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://rptxfjlxymfmxucctuhc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdHhmamx4eW1mbXh1Y2N0dWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTcxNjMsImV4cCI6MjA3NzEzMzE2M30.kQSF0jp_-0Qi2AmHQNKz6eTo7zeEi3b7Lk9UjT216dU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // IMPORTANTE: Cole aqui a sua "Public Key" gerada no site vapidkeys.com
    const VAPID_PUBLIC_KEY = 'BJvCCJUx9FbMq2dyyVs6dBbdNDAC28UvY8oiZ5sCpyHI2h4meqo8E73tQ10AiPqfcQcgMxgyc458P-n2UZl9gNs';

    // --- Seletores de Elementos ---
    const celularSelect = document.getElementById('celularSelect');
    const subscribeButton = document.getElementById('subscribeButton');
    const statusMsg = document.getElementById('statusMsg');
    const loadingMsg = document.getElementById('loadingMsg');
    const installContainer = document.getElementById('install-container');
    const installButton = document.getElementById('install-button');

    // ==================== PWA / SERVICE WORKER ====================
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('beforeinstallprompt event fired');
      e.preventDefault();
      deferredPrompt = e;
      installContainer.classList.remove('hidden');
      installContainer.classList.add('flex');
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installContainer.classList.add('hidden');
      }
    });
    
    window.addEventListener('appinstalled', () => {
        installContainer.classList.add('hidden');
        deferredPrompt = null;
    });

    // ==================== L√ìGICA DE PUSH NOTIFICATION ====================
    
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    async function subscribeUserToPush() {
        const celularId = celularSelect.value;
        if (!celularId) {
            statusMsg.textContent = '‚ùå Por favor, selecione um celular primeiro.';
            return;
        }
        
        if (VAPID_PUBLIC_KEY === 'YOUR_VAPID_PUBLIC_KEY') {
            statusMsg.innerHTML = '‚ùå Configura√ß√£o pendente: <strong>VAPID_PUBLIC_KEY</strong> n√£o foi definida no c√≥digo.';
            return;
        }

        try {
            statusMsg.textContent = 'üîÑ Solicitando permiss√£o para notifica√ß√µes...';
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                throw new Error('Permiss√£o para notifica√ß√µes n√£o foi concedida.');
            }

            statusMsg.textContent = 'üîÑ Inscrevendo para receber notifica√ß√µes push...';
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            statusMsg.textContent = 'üíæ Salvando inscri√ß√£o no servidor...';
            const { error } = await supabase
                .from('push_subscriptions')
                .upsert({ 
                    usuario_id: celularId, 
                    subscription_info: subscription 
                }, { onConflict: 'usuario_id' });

            if (error) throw error;
            
            localStorage.setItem('pushSubscribedId', celularId);
            updateUIForSubscribed(celularId);
            statusMsg.textContent = '‚úÖ Rastreamento On-Demand ativado com sucesso!';

        } catch (error) {
            console.error('Falha ao inscrever para push notifications:', error);
            statusMsg.textContent = `‚ùå Erro: ${error.message}`;
            updateUIForUnsubscribed();
        }
    }

    async function unsubscribeUserFromPush() {
        const celularId = localStorage.getItem('pushSubscribedId');
        if (!celularId) return;

        try {
            statusMsg.textContent = 'üîÑ Cancelando inscri√ß√£o...';
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.getSubscription();
            if (subscription) {
                await subscription.unsubscribe();
            }

            const { error } = await supabase
                .from('push_subscriptions')
                .delete()
                .eq('usuario_id', celularId);
            
            if (error) console.warn('Falha ao remover inscri√ß√£o do DB, mas continuando:', error.message);

            localStorage.removeItem('pushSubscribedId');
            updateUIForUnsubscribed();
            statusMsg.textContent = 'Rastreamento On-Demand foi desativado.';

        } catch (error) {
            console.error('Falha ao cancelar inscri√ß√£o:', error);
            statusMsg.textContent = `‚ùå Erro ao cancelar: ${error.message}`;
        }
    }

    // ==================== UI (Interface do Usu√°rio) ====================

    function updateUIForSubscribed(celularId) {
        subscribeButton.textContent = '‚úÖ Rastreamento Ativo (Cancelar)';
        subscribeButton.onclick = unsubscribeUserFromPush;
        subscribeButton.disabled = false;
        celularSelect.value = celularId;
        celularSelect.disabled = true;
    }

    function updateUIForUnsubscribed() {
        subscribeButton.textContent = 'üîî Ativar Rastreamento On-Demand';
        subscribeButton.onclick = subscribeUserToPush;
        subscribeButton.disabled = false;
        celularSelect.disabled = false;
    }

    // ==================== INICIALIZA√á√ÉO ====================
    
    async function carregarCelulares() {
      try {
        loadingMsg.textContent = 'üîÑ Carregando...';
        const { data, error } = await supabase.from('usuarios_localizacao').select('id,nome,numero').filter('numero', 'not.is', null).filter('numero', 'neq', '');
        if (error) throw error;

        celularSelect.innerHTML = '<option value="">Selecione...</option>';
        if (data && data.length > 0) {
          data.forEach(c => { celularSelect.innerHTML += `<option value="${c.id}">${c.nome} (${c.numero})</option>`; });
          loadingMsg.textContent = `‚úÖ ${data.length} celular(es) encontrado(s)`;
          subscribeButton.disabled = false;
        } else {
          loadingMsg.textContent = 'Nenhum celular cadastrado.';
          subscribeButton.disabled = true;
        }
      } catch (err) {
        console.error('Erro ao carregar celulares:', err); 
        loadingMsg.textContent = '‚ùå Erro ao carregar celulares.';
        subscribeButton.disabled = true;
      }
    }

    async function checkCurrentSubscription() {
        statusMsg.textContent = 'Verificando status...';
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        const subscribedId = localStorage.getItem('pushSubscribedId');

        if (subscription && subscribedId) {
            console.log('Usu√°rio j√° inscrito para o celular ID:', subscribedId);
            updateUIForSubscribed(subscribedId);
            statusMsg.textContent = 'Rastreamento On-Demand est√° ativo.';
        } else {
            console.log('Usu√°rio n√£o inscrito.');
            updateUIForUnsubscribed();
            statusMsg.textContent = 'Selecione seu celular para ativar o rastreamento.';
        }
    }

    async function initialize() {
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            console.log('Service Worker e Push s√£o suportados.');
            try {
                await navigator.serviceWorker.register('/sw_background.js', { scope: '/' });
                console.log('Service Worker registrado.');
                await carregarCelulares();
                await checkCurrentSubscription();
            } catch (error) {
                console.error('Falha na inicializa√ß√£o:', error);
                statusMsg.textContent = '‚ùå Erro cr√≠tico na inicializa√ß√£o do app.';
            }
        } else {
            statusMsg.textContent = '‚ùå Notifica√ß√µes Push n√£o s√£o suportadas neste navegador.';
            console.warn('Service Worker ou PushManager n√£o suportado.');
            subscribeButton.disabled = true;
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);

  </script>
</body>
</html>
