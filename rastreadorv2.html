<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>GEOMAQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      min-height: 100vh; 
    }
    .status-indicator {
      width: 12px; height: 12px; border-radius: 50%;
      display: inline-block; margin-right: 8px;
    }
    .status-active { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
    .status-inactive { background-color: #ef4444; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    #menuNav {
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }
    #menuNav.open {
      transform: translateX(0);
    }
    #menuOverlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out, visibility 0.3s;
    }
    #menuOverlay.open {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-700 via-purple-700 to-violet-800 text-gray-900">

  <audio id="silentAudio" loop>
    <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA" type="audio/wav">
  </audio>

  <div id="install-container" class="bg-indigo-800 text-white p-3 text-center hidden items-center justify-center gap-4">
    <p class="font-medium">Instale o app para a melhor experi√™ncia!</p>
    <button id="install-button" class="bg-white text-indigo-700 font-bold py-1 px-4 rounded-lg shadow-md hover:bg-indigo-100 transition-all">
      Instalar App
    </button>
  </div>

  <header class="bg-white/90 shadow-md p-4 flex justify-between items-center sticky top-0 z-20">
    <div>
      <h1 class="text-xl font-extrabold text-indigo-700 drop-shadow">GEOMAQ</h1>
      <p class="text-sm text-gray-600 font-medium">LOCALIZADOR DE M√ÅQUINAS</p>
    </div>
    <button id="menuButton" class="p-2 z-40">
      <svg class="w-6 h-6 text-indigo-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h16"></path>
      </svg>
    </button>
  </header>

  <div id="menuOverlay" class="fixed inset-0 bg-black/50 z-20 md-hidden"></div>

  <nav id="menuNav" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-30 p-6">
    <h2 class="text-lg font-bold text-indigo-700 mb-6">Menu</h2>
    <ul>
      <li>
        <a href="#" id="navHome" class="nav-link block py-2 px-4 rounded-lg font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">In√≠cio</a>
      </li>
      <li>
        <a href="#" id="navRastreador" class="nav-link block py-2 px-4 rounded-lg font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Rastreamento</a>
      </li>
    </ul>
  </nav>

  <div class="relative min-h-screen">
    
    <main id="homePage" class="page-content p-6 flex flex-col items-center justify-center text-center" style="min-height: 80vh;">
      <h2 class="text-3xl font-bold text-white mb-8 drop-shadow-lg">Bem-vindo</h2>
      
      <div class="w-full max-w-md mb-8">
        <label for="celularSelect" class="block text-white/90 font-semibold mb-2 text-sm text-left">Selecione seu celular:</label>
        <select id="celularSelect" required class="w-full px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 text-base shadow text-gray-900">
          <option value="">Carregando...</option>
        </select>
        <div id="loadingMsg" class="mt-2 text-xs text-white/80 text-left"></div>
      </div>
      
      <button id="homeEntrouBtn" 
              class="w-48 h-48 bg-gradient-to-br from-purple-500 to-indigo-600 text-white font-bold text-2xl
                     rounded-2xl shadow-2xl 
                     flex items-center justify-center text-center
                     transition-all duration-300 
                     hover:scale-110 hover:shadow-cyan-300/30
                     active:scale-100 active:shadow-lg
                     focus:outline-none focus:ring-4 focus:ring-purple-300">
        ESTOU AQUI
      </button>

      <div id="homeStatusMsg" class="mt-6 text-center text-lg font-medium text-white/90"></div>
    </main>

    <main id="rastreadorPage" class="page-content p-6 hidden flex items-center justify-center" style="min-height: 80vh;">
      <div class="w-full max-w-md rounded-2xl shadow-2xl bg-white/95 mx-auto p-6">
        
        <!-- NOVO: AVISO DE PERMISS√ÉO -->
        <div id="permission-warning" class="hidden mb-4 p-4 rounded-lg bg-yellow-100 border-l-4 border-yellow-500">
            <h3 class="font-bold text-yellow-800">‚ö†Ô∏è A√ß√£o Necess√°ria!</h3>
            <p class="text-sm text-yellow-700 mt-1">
                Para o rastreamento funcionar com a tela desligada, a permiss√£o de localiza√ß√£o deve ser <strong>"Permitir o tempo todo"</strong>.
            </p>
            <p class="text-xs text-yellow-600 mt-2">
                V√° em: Configura√ß√µes do Celular ‚Üí Apps ‚Üí GEOMAQ ‚Üí Permiss√µes ‚Üí Localiza√ß√£o ‚Üí Permitir o tempo todo.
            </p>
        </div>

        <h1 class="text-2xl font-extrabold text-indigo-700 mb-4 text-center drop-shadow">üõ∞Ô∏è Rastreamento Cont√≠nuo</h1>
        
        <div id="statusContainer" class="mb-4 p-4 rounded-xl border-2 border-gray-200 bg-gray-50">
          <div class="flex items-center justify-between mb-2">
            <span class="font-bold text-gray-700">Status:</span>
            <div id="statusIndicator" class="flex items-center">
              <span class="status-indicator status-inactive"></span>
              <span id="statusText" class="text-sm font-medium text-gray-600">Inativo</span>
            </div>
          </div>
          <div class="text-xs text-gray-500">
            <div>Intervalo de envio: <span class="font-semibold">5 minutos</span></div>
            <div>√öltimo envio: <span id="ultimoEnvio" class="font-semibold">Nunca</span></div>
            <div>Envios realizados: <span id="contagemEnvios" class="font-semibold">0</span></div>
            <div id="wakeLockStatus" class="mt-2 pt-2 border-t hidden">
              <span id="wakeLockIcon" class="font-semibold"></span> <span id="wakeLockText" class="text-gray-600"></span>
            </div>
          </div>
        </div>

        <form id="enviarLocalizacaoForm" class="flex flex-col gap-5">
          <button type="button" id="liberarBtn"
            class="w-full bg-gradient-to-tr from-purple-600 to-indigo-700 text-white font-bold rounded-xl py-3 shadow-xl text-lg hover:scale-105 transition active:scale-95">
            üöÄ Iniciar Rastreamento
          </button>
          
          <button type="button" id="pararBtn"
            class="w-full bg-gradient-to-tr from-red-600 to-red-700 text-white font-bold rounded-xl py-3 shadow-xl text-lg hover:scale-105 transition active:scale-95 hidden">
            ‚èπÔ∏è Parar Rastreamento
          </button>
          
          <div id="statusMsg" class="mt-2 text-center text-sm font-medium"></div>
        </form>
      </div>
    </main>

  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://rptxfjlxymfmxucctuhc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwdHhmamx4eW1mbXh1Y2N0dWhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NTcxNjMsImV4cCI6MjA3NzEzMzE2M30.kQSF0jp_-0Qi2AmHQNKz6eTo7zeEi3b7Lk9UjT216dU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const INTERVALO_MS = 5 * 60 * 1000;
    
    let watchId = null;
    let lastSentTimestamp = 0;
    let contagemEnvios = 0;
    let wakeLock = null;

    // --- Seletores de Elementos ---
    const celularSelect = document.getElementById('celularSelect');
    const liberarBtn = document.getElementById('liberarBtn');
    const pararBtn = document.getElementById('pararBtn');
    const statusMsg = document.getElementById('statusMsg');
    const loadingMsg = document.getElementById('loadingMsg');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const ultimoEnvioEl = document.getElementById('ultimoEnvio');
    const contagemEnviosEl = document.getElementById('contagemEnvios');
    const menuButton = document.getElementById('menuButton');
    const menuNav = document.getElementById('menuNav');
    const menuOverlay = document.getElementById('menuOverlay');
    const homePage = document.getElementById('homePage');
    const rastreadorPage = document.getElementById('rastreadorPage');
    const homeEntrouBtn = document.getElementById('homeEntrouBtn');
    const homeStatusMsg = document.getElementById('homeStatusMsg');
    const silentAudio = document.getElementById('silentAudio');
    const wakeLockStatus = document.getElementById('wakeLockStatus');
    const wakeLockIcon = document.getElementById('wakeLockIcon');
    const wakeLockText = document.getElementById('wakeLockText');
    const permissionWarning = document.getElementById('permission-warning');

    // ==================== PWA / SERVICE WORKER ====================
    let deferredPrompt;
    const installContainer = document.getElementById('install-container');
    const installButton = document.getElementById('install-button');

    window.addEventListener('beforeinstallprompt', (e) => {
      console.log("‚úÖ 'beforeinstallprompt' foi disparado! O PWA √© instal√°vel.");
      e.preventDefault();
      deferredPrompt = e;
      installContainer.classList.remove('hidden');
      installContainer.classList.add('flex');
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        deferredPrompt = null;
        installContainer.classList.add('hidden');
      }
    });
    
    window.addEventListener('appinstalled', () => {
        installContainer.classList.add('hidden');
        deferredPrompt = null;
        console.log('PWA foi instalado');
    });

    async function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/sw_background.js', { scope: '/' });
                console.log('‚úÖ Service Worker registrado com sucesso:', registration);
            } catch (error) {
                console.error('‚ùå Falha ao registrar Service Worker:', error);
            }
        }
    }

    // ==================== PERMISS√ïES E NOTIFICA√á√ïES ====================
    
    // NOVO: Fun√ß√£o para verificar permiss√µes de localiza√ß√£o em segundo plano
    async function checkBackgroundLocationPermission() {
        if ('permissions' in navigator) {
            try {
                // 'geolocation' √© a permiss√£o padr√£o, mas n√£o diferencia foreground/background
                const status = await navigator.permissions.query({ name: 'geolocation' });
                
                // A √∫nica maneira de SABER se temos permiss√£o de background √© tentar us√°-la e falhar.
                // Como n√£o podemos saber diretamente, vamos INSTRUIR o usu√°rio e assumir que ele precisa agir.
                // O aviso ser√° mostrado por padr√£o e s√≥ ser√° escondido se o rastreamento funcionar.
                permissionWarning.classList.remove('hidden');

                status.onchange = () => {
                    if (status.state === 'granted') {
                        // O usu√°rio pode ter concedido, mas ainda n√£o sabemos se √© "o tempo todo".
                        // O aviso continua por enquanto.
                    } else {
                        permissionWarning.classList.remove('hidden');
                    }
                };
            } catch (e) {
                console.warn("API de permiss√µes n√£o suportada ou erro:", e);
                // Se a API n√£o for suportada, mostramos o aviso como precau√ß√£o.
                permissionWarning.classList.remove('hidden');
            }
        } else {
            permissionWarning.classList.remove('hidden');
        }
    }


    async function solicitarPermissaoNotificacao() {
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission();
      }
    }

    function enviarNotificacao(titulo, mensagem) {
      if ('Notification' in window && Notification.permission === 'granted') {
        try {
          // ATUALIZADO: Adicionado 'requireInteraction' para tornar a notifica√ß√£o persistente
          navigator.serviceWorker.ready.then(registration => {
            registration.showNotification(titulo, { 
                body: mensagem, 
                icon: '/icon-192.png', 
                tag: 'rastreamento-gps',
                requireInteraction: true // Ajuda a sinalizar ao SO que √© uma tarefa importante
            });
          });
        } catch (err) { console.log('Erro notifica√ß√£o:', err); }
      }
    }
    
    // ==================== WAKE LOCK API ====================
    const requestWakeLock = async () => {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLockStatus.classList.remove('hidden');
          wakeLockIcon.textContent = 'üîí';
          wakeLockText.textContent = 'Tela mantida ativa para garantir o rastreamento.';
          wakeLock.addEventListener('release', () => { wakeLock = null; wakeLockStatus.classList.add('hidden'); });
        } catch (err) {
          wakeLockStatus.classList.remove('hidden');
          wakeLockIcon.textContent = '‚ö†Ô∏è';
          wakeLockText.textContent = 'N√£o foi poss√≠vel manter a tela ativa.';
        }
      }
    };

    const releaseWakeLock = async () => {
      if (wakeLock !== null) {
        await wakeLock.release();
        wakeLock = null;
      }
    };

    // ==================== UI (Interface do Usu√°rio) ====================
    function atualizarStatusUI(ativo) {
      if (ativo) {
        statusIndicator.innerHTML = '<span class="status-indicator status-active pulse"></span>';
        statusText.textContent = 'Rastreando';
        liberarBtn.classList.add('hidden');
        pararBtn.classList.remove('hidden');
        homeStatusMsg.textContent = 'Rastreamento ATIVO üöÄ';
        homeStatusMsg.className = 'mt-6 text-center text-lg font-bold text-green-300 drop-shadow';
      } else {
        statusIndicator.innerHTML = '<span class="status-indicator status-inactive"></span>';
        statusText.textContent = 'Inativo';
        liberarBtn.classList.remove('hidden');
        pararBtn.classList.add('hidden');
        homeStatusMsg.textContent = 'Rastreamento inativo.';
        homeStatusMsg.className = 'mt-6 text-center text-lg font-medium text-white/90';
      }
    }

    // ==================== SUPABASE & L√ìGICA DE DADOS ====================
    async function carregarCelulares() {
      try {
        loadingMsg.textContent = 'üîÑ Carregando...';
        const { data, error } = await supabase.from('usuarios_localizacao').select('id,nome,numero').filter('numero', 'not.is', null).filter('numero', 'neq', '');
        if (error) throw error;

        celularSelect.innerHTML = '<option value="">Selecione...</option>';
        if (data && data.length > 0) {
          data.forEach(c => { celularSelect.innerHTML += `<option value="${c.id}">${c.nome} (${c.numero})</option>`; });
          loadingMsg.textContent = `‚úÖ ${data.length} celular(es) encontrado(s)`;
        } else {
          loadingMsg.textContent = 'Nenhum celular cadastrado.';
        }
        
        const savedId = localStorage.getItem('lastSelectedCelularId');
        if (savedId) celularSelect.value = savedId;

        if (localStorage.getItem('rastreamentoAtivo') === 'true' && savedId) {
          setTimeout(() => {
            console.log("Iniciando rastreamento autom√°tico salvo...");
            celularSelect.value = savedId;
            iniciarRastreamento();
          }, 1000);
        } else {
          atualizarStatusUI(false);
        }
      } catch (err) {
        console.error('Erro ao carregar celulares:', err); 
        loadingMsg.textContent = '‚ùå Erro ao carregar celulares.';
      }
    }
    
    // ==================== L√ìGICA PRINCIPAL DE RASTREAMENTO ====================
    
    async function handlePositionUpdate(posicao) {
        // Se recebemos uma posi√ß√£o, significa que a permiss√£o est√° funcionando. Esconde o aviso.
        permissionWarning.classList.add('hidden');

        const now = Date.now();
        const tempoDesdeUltimoEnvio = now - lastSentTimestamp;

        if (lastSentTimestamp !== 0 && tempoDesdeUltimoEnvio < INTERVALO_MS) {
            const tempoRestanteMin = Math.round((INTERVALO_MS - tempoDesdeUltimoEnvio) / 60000);
            const msg = `üõ∞Ô∏è Posi√ß√£o recebida. Pr√≥ximo envio em ~${tempoRestanteMin} min.`;
            statusMsg.textContent = msg;
            console.log(msg);
            return;
        }

        console.log('Intervalo de 5 minutos atingido. Enviando localiza√ß√£o.');
        
        const celularId = localStorage.getItem('lastSelectedCelularId');
        if (!celularId) return;

        statusMsg.textContent = "üì§ Enviando localiza√ß√£o...";
        homeStatusMsg.textContent = "üì§ Enviando localiza√ß√£o...";
      
        try {
            const { error: updateError } = await supabase.from('usuarios_localizacao').update({
                latitude: posicao.coords.latitude,
                longitude: posicao.coords.longitude,
                created_at: new Date().toISOString()
            }).eq('id', celularId);
            if (updateError) throw updateError;
            
            const { error: insertError } = await supabase.from('historico_localizacao').insert({
                usuario_id: celularId,
                latitude: posicao.coords.latitude,
                longitude: posicao.coords.longitude
            });
            if (insertError) throw insertError;

            lastSentTimestamp = now;
            contagemEnvios++;
            
            localStorage.setItem('contagemEnvios', contagemEnvios);
            localStorage.setItem('lastSentTimestamp', lastSentTimestamp);
            
            contagemEnviosEl.textContent = contagemEnvios;
            const horario = new Date().toLocaleTimeString('pt-BR');
            ultimoEnvioEl.textContent = horario;
            
            const successMsg = '‚úÖ Localiza√ß√£o enviada √†s ' + horario;
            statusMsg.textContent = successMsg;
            homeStatusMsg.textContent = successMsg;

            enviarNotificacao('Localiza√ß√£o Enviada', `Envio #${contagemEnvios} realizado com sucesso.`);

        } catch (erro) {
            console.error('‚ùå Falha ao enviar para o Supabase:', erro);
            const errorMsg = "‚ùå Falha ao enviar dados.";
            statusMsg.textContent = errorMsg;
            homeStatusMsg.textContent = errorMsg;
        }
    }

    function handlePositionError(erro) {
        let errorMessage = "Erro desconhecido ao obter GPS.";
        if (erro && erro.code) {
            if (erro.code === 1) errorMessage = "Permiss√£o de GPS negada.";
            else if (erro.code === 2) errorMessage = "N√£o foi poss√≠vel obter a localiza√ß√£o (sinal fraco).";
            else if (erro.code === 3) errorMessage = "Tempo esgotado para obter sinal de GPS.";
        }
        console.error('‚ùå Erro de Geolocaliza√ß√£o:', errorMessage, erro);
        statusMsg.textContent = "‚ùå " + errorMessage;
        homeStatusMsg.textContent = "‚ùå " + errorMessage;

        if (erro.code === 1) { // Permiss√£o negada √© um erro fatal
            pararRastreamento();
            permissionWarning.classList.remove('hidden'); // Mostra o aviso se a permiss√£o for negada
        }
    }

    async function iniciarRastreamento() {
      const celularId = celularSelect.value;
      if (!celularId) {
        const msg = "‚ùå Selecione um celular primeiro";
        statusMsg.textContent = msg;
        homeStatusMsg.textContent = msg;
        return;
      }

      if (!('geolocation' in navigator)) {
        statusMsg.textContent = '‚ùå Geolocaliza√ß√£o n√£o √© suportada neste navegador.';
        return;
      }

      console.log('üöÄ Iniciando rastreamento cont√≠nuo para:', celularId);
      await solicitarPermissaoNotificacao();
      await checkBackgroundLocationPermission();
      
      await requestWakeLock();
      silentAudio.play().catch(e => console.warn('Falha ao tocar √°udio silencioso:', e));
      
      const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 };
      watchId = navigator.geolocation.watchPosition(handlePositionUpdate, handlePositionError, options);

      localStorage.setItem('rastreamentoAtivo', 'true');
      localStorage.setItem('lastSelectedCelularId', celularId);
      lastSentTimestamp = 0;
      
      atualizarStatusUI(true);
      statusMsg.textContent = "üõ∞Ô∏è Rastreamento ativado. Aguardando primeiro sinal do GPS...";
      enviarNotificacao('Rastreamento Iniciado', 'O envio ocorrer√° a cada 5 minutos.');
    }
    
    async function pararRastreamento() {
      console.log('‚èπÔ∏è Parando rastreamento cont√≠nuo...');
      
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      
      await releaseWakeLock();
      
      silentAudio.pause();
      silentAudio.currentTime = 0;
      
      localStorage.setItem('rastreamentoAtivo', 'false');
      atualizarStatusUI(false);
      
      statusMsg.textContent = "‚èπÔ∏è Rastreamento parado.";
      homeStatusMsg.textContent = "‚èπÔ∏è Rastreamento parado.";
      
      enviarNotificacao('Rastreamento Parado', 'O rastreamento foi interrompido.');
    }

    // ==================== NAVEGA√á√ÉO E INICIALIZA√á√ÉO ====================
    function toggleMenu() {
      menuNav.classList.toggle('open');
      menuOverlay.classList.toggle('open');
    }

    function navegarPara(pagina) {
      homePage.classList.add('hidden');
      rastreadorPage.classList.add('hidden');
      if (pagina === 'home') homePage.classList.remove('hidden');
      else if (pagina === 'rastreador') {
          rastreadorPage.classList.remove('hidden');
          checkBackgroundLocationPermission(); // Verifica a permiss√£o sempre que a p√°gina de rastreamento for aberta
      }
      if(menuNav.classList.contains('open')) toggleMenu();
    }

    celularSelect.addEventListener('change', (e) => {
      if (e.target.value) localStorage.setItem('lastSelectedCelularId', e.target.value);
    });
    liberarBtn.addEventListener('click', iniciarRastreamento);
    pararBtn.addEventListener('click', pararRastreamento);
    homeEntrouBtn.addEventListener('click', () => {
        navegarPara('rastreador');
        setTimeout(iniciarRastreamento, 100);
    });
    menuButton.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);
    document.getElementById('navHome').addEventListener('click', (e) => { e.preventDefault(); navegarPara('home'); });
    document.getElementById('navRastreador').addEventListener('click', (e) => { e.preventDefault(); navegarPara('rastreador'); });

    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && localStorage.getItem('rastreamentoAtivo') === 'true') {
        console.log('üëÅÔ∏è App vis√≠vel, reativando Wake Lock e for√ßando checagem.');
        await requestWakeLock();
        navigator.geolocation.getCurrentPosition(handlePositionUpdate, handlePositionError, { enableHighAccuracy: true, timeout: 15000 });
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Inicializando App GEOMAQ v6 (Permission Check)...');
      await registerServiceWorker();
      contagemEnvios = parseInt(localStorage.getItem('contagemEnvios')) || 0;
      contagemEnviosEl.textContent = contagemEnvios;
      const ultimoTs = parseInt(localStorage.getItem('lastSentTimestamp')) || 0;
      if (ultimoTs) {
          ultimoEnvioEl.textContent = new Date(ultimoTs).toLocaleTimeString('pt-BR');
      }
      await carregarCelulares();
    });
  </script>
</body>
</html>
